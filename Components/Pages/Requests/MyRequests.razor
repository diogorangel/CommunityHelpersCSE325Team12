@page "/requests/my-requests"
@using CommunityHelpers.Blazor.Models
@using CommunityHelpers.Blazor.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.EntityFrameworkCore
@attribute [Authorize]
@rendermode InteractiveServer
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>My Requests | Community Helpers</PageTitle>

<div class="container py-4">
    <h1 class="mb-4 fw-bold">Manage My Requests</h1>

    @if (myRequests == null)
    {
        <div class="d-flex justify-content-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    }
    else if (!myRequests.Any())
    {
        <div class="alert alert-info shadow-sm" role="alert">
            <i class="bi bi-info-circle me-2"></i> You haven't created any help requests yet. 
            <a href="requests/create" class="alert-link">Create one now?</a>
        </div>
    }
    else
    {
        <div class="table-responsive shadow-sm rounded">
            <table class="table table-hover align-middle bg-white mb-0">
                <thead class="table-dark">
                    <tr>
                        <th scope="col">Title</th>
                        <th scope="col">Category</th>
                        <th scope="col">Created By</th>
                        <th scope="col">Assigned To</th>
                        <th scope="col">Status</th>
                        <th scope="col" class="text-center">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var req in myRequests)
                    {
                        <tr>
                            <td><strong>@req.Title</strong></td>
                            <td><span class="badge bg-secondary">@req.Category</span></td>
                            <td class="small text-muted">@req.RequesterId</td>
                            <td>
                                @if (!string.IsNullOrEmpty(req.VolunteerId))
                                {
                                    <span class="badge bg-info text-dark">
                                        <i class="bi bi-person-check-fill me-1"></i> @req.VolunteerId
                                    </span>
                                }
                                else
                                {
                                    <span class="text-muted small fst-italic">Waiting for volunteer...</span>
                                }
                            </td>
                            <td>
                                <span class="badge @GetStatusClass(req.Status)">@req.Status</span>
                            </td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    @if (req.Status != "Completed")
                                    {
                                        <button class="btn btn-sm btn-success" 
                                                @onclick="() => MarkAsCompleted(req.Id)"
                                                title="Mark as completed"
                                                aria-label="Mark as completed: @req.Title">
                                            <i class="bi bi-check-lg"></i>
                                        </button>
                                    }
                                    <button class="btn btn-sm btn-outline-danger" 
                                            @onclick="() => DeleteRequest(req.Id)"
                                            title="Delete request"
                                            aria-label="Delete request: @req.Title">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }
</div>

@code {
    private List<HelpRequest>? myRequests;
    private string currentUserName = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        currentUserName = authState.User.Identity?.Name ?? "";
        
        await LoadMyRequests();
    }

    private async Task LoadMyRequests()
    {
        using var context = DbFactory.CreateDbContext();
        
        // Filter: Show only requests created by the current user
        myRequests = await context.HelpRequests
            .Where(r => r.RequesterId == currentUserName)
            .OrderByDescending(r => r.Id)
            .ToListAsync();
    }

    private async Task MarkAsCompleted(int id)
    {
        using var context = DbFactory.CreateDbContext();
        var req = await context.HelpRequests.FindAsync(id);
        
        if (req != null && req.RequesterId == currentUserName)
        {
            req.Status = "Completed";
            await context.SaveChangesAsync();
            await LoadMyRequests();
        }
    }

    private async Task DeleteRequest(int id)
    {
        using var context = DbFactory.CreateDbContext();
        var req = await context.HelpRequests.FindAsync(id);
        
        if (req != null && req.RequesterId == currentUserName)
        {
            context.HelpRequests.Remove(req);
            await context.SaveChangesAsync();
            await LoadMyRequests();
        }
    }

    private string GetStatusClass(string status) => status switch
    {
        "Pending" => "bg-warning text-dark",
        "In-Progress" => "bg-info text-white",
        "Completed" => "bg-success text-white",
        _ => "bg-secondary"
    };
}